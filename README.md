<p align="center">
    <h1 align="center"></h1>
</p>
<p align="center">
    <h1 align="center">SepAl: Sepsis Prediction on the Edge</h1>
</p>
<p align="center">
	<!-- local repository, no metadata badges. -->
<p>
<p align="center">
		<em>Developed with the software and tools below:</em>
</p>
<p align="center">
	<img src="https://img.shields.io/badge/tqdm-FFC107.svg?style=default&logo=tqdm&logoColor=black" alt="tqdm">
	<img src="https://img.shields.io/badge/TensorFlow-FF6F00.svg?style=default&logo=TensorFlow&logoColor=white" alt="TensorFlow">
	<img src="https://img.shields.io/badge/scikitlearn-F7931E.svg?style=default&logo=scikit-learn&logoColor=white" alt="scikitlearn">
	<img src="https://img.shields.io/badge/Keras-D00000.svg?style=default&logo=Keras&logoColor=white" alt="Keras">
	<img src="https://img.shields.io/badge/YAML-CB171E.svg?style=default&logo=YAML&logoColor=white" alt="YAML">
	<img src="https://img.shields.io/badge/Jinja-B41717.svg?style=default&logo=Jinja&logoColor=white" alt="Jinja">
	<br>
	<img src="https://img.shields.io/badge/SciPy-8CAAE6.svg?style=default&logo=SciPy&logoColor=white" alt="SciPy">
	<img src="https://img.shields.io/badge/SymPy-3B5526.svg?style=default&logo=SymPy&logoColor=white" alt="SymPy">
	<img src="https://img.shields.io/badge/Python-3776AB.svg?style=default&logo=Python&logoColor=white" alt="Python">
	<img src="https://img.shields.io/badge/pandas-150458.svg?style=default&logo=pandas&logoColor=white" alt="pandas">
	<img src="https://img.shields.io/badge/NumPy-013243.svg?style=default&logo=NumPy&logoColor=white" alt="NumPy">
	<img src="https://img.shields.io/badge/Markdown-000000.svg?style=default&logo=Markdown&logoColor=white" alt="Markdown">
</p>

---

##  Overview

This repo contains the code to train, quantise and test the models used in the paper <em>"SepAl: Sepsis Alerts On Low Power Wearables With Digital Biomarkers and On-Device Tiny Machine Learning"<em>.

This repo contains the code to:
- Import a data-intensive dataset featuring high-density data into an SQL server
- Generating Sepsis-3 labels
- Create a subset of the dataset under certain inclusion criteria
- Train and evaluate a PyTorch model on the said dataset
- Train, quantise and evaluate a Tensorflow model on the said dataset


---

##  Abstract

Sepsis is a lethal syndrome of organ dysfunction that is triggered by an infection and claims 11 million lives per year globally. 
Prognostic algorithms based on deep learning have shown promise in detecting the onset of sepsis hours before the actual event but use a large number of bio-markers, including vital signs and laboratory tests. The latter makes the deployment of such systems outside hospitals or in resource-limited environments extremely challenging. This paper introduces SepAl, an energy-efficient and lightweight neural network, using only data from low-power wearable sensors, such as photoplethysmography (PPG), inertial measurement units (IMU), and body temperature sensors, designed to deliver alerts in real-time. SepAl leverages only six digitally acquirable vital signs and tiny machine learning algorithms, enabling on-device real-time sepsis prediction.  

SepAl uses a lightweight temporal convolution neural network capable of providing sepsis alerts with a median predicted time to sepsis of 9.8 hours. The model has been fully quantized, being able to be deployed on any low-power processors, and evaluated on an ARM Cortex-M33 core. Experimental evaluations show an inference efficiency of 0.11MAC/Cycle and a latency of 143ms, with an energy per inference of 2.68mJ. This work aims at paving the way toward accurate disease prediction, deployable in a long-lasting multi-vital sign wearable device, suitable for providing sepsis onset alerts at the point of care.

---

##  Getting Started

**System Requirements:**

* **Python**: `version 3.8.11`

###  Installation

<h4>From <code>source</code></h4>

> 1. Clone the  repository:
>
> ```console
> $ git clone https://git.ee.ethz.ch/pbl/research/sepsis_prediction
> ```
>
> 2. Change to the project directory:
> ```console
> $ cd sepsis_prediction
> ```
>
> 3. Install the dependencies:
> ```console
> $ pip install -r requirements.txt
> ```

---
##  Usage


### SQL data loading

The HiRID dataset is hosted on [Physionet](https://physionet.org/content/hirid/1.1.1/). Given the dimension of the data, it was impossible to load the whole dataset in RAM, therefore the dataset was loaded on a PostgreSQL server. The code to load the data into the SQL server is located in [SQL_scripts](./SQL_scripts).
The dataset is provided as a key-value store, the list of keys is hosted on a excel sheet, also loaded in this repository. To make operations in Python easier, as well as making the values easier to read and understand, another SQL script, automatically generated by a small python script, can be run.
As a general remark, it is very important to create an index for the database, as it massively speeds up the data retrieving process. An index is automatically created with the provided SQL scripts.

### Dataset Generation

<h4>Generate the dataset</h4>

Set the settings for dataset generator in `dataset_config.yaml`

> Run  using the command below specifying the dataset desired:
> ```console
> $ python generate_dataset.py --dataset hirid
> ```

> Copy the dataset generated from `dataset_gen_runs/` to `generated_datasets/`:
> ```console
> $ cp dataset_gen_runs/hirid_* cp generated_datasets/hirid_*
> ```


### Model training and testing

Set the settings for model training in `network_config.yaml`

<h4>Train and test PyTorch model</h4>

> Run  using the command below:
> ```console
> $ python python train_net.py
> ```

<h4>Train, quantise and test TensorFlow model</h4>

> Run  using the command below:
> ```console
> $ python python train_net_tf.py
> ```

